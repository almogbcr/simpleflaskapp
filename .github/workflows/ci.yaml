name: Build and Update GitOps

on:
  push:
    branches:
      - dev
      - main

permissions:
  contents: write

jobs:
  build-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout app repo
      uses: actions/checkout@v4

    - name: Set IMAGE TAG
      id: vars
      run: echo "SHA_TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and Push Image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/simpleflaskapp:${{ steps.vars.outputs.SHA_TAG }} .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/simpleflaskapp:${{ steps.vars.outputs.SHA_TAG }}

    - name: Update GitOps values and push to matching branch
      shell: bash
      env:
        SHA_TAG: ${{ steps.vars.outputs.SHA_TAG }}
        SOURCE_BRANCH: ${{ github.ref_name }}
        GITOPS_TOKEN: ${{ secrets.GITOPS_REPO_TOKEN != '' && secrets.GITOPS_REPO_TOKEN || github.token }}
      run: |
        set -euo pipefail

        case "$SOURCE_BRANCH" in
          dev)
            TARGET_BRANCH="dev"
            VALUES_FILE="charts/myapp/values-dev.yaml"
            ;;
          main)
            TARGET_BRANCH="main"
            VALUES_FILE="charts/myapp/values-prod.yaml"
            ;;
          *)
            echo "Source branch '$SOURCE_BRANCH' is not mapped for GitOps updates. Skipping."
            exit 0
            ;;
        esac

        echo "Source branch: $SOURCE_BRANCH"
        echo "Target GitOps branch: $TARGET_BRANCH"
        echo "Values file to update: $VALUES_FILE"
        echo "New image tag: $SHA_TAG"

        git clone --single-branch --branch "$TARGET_BRANCH" \
          "https://x-access-token:${GITOPS_TOKEN}@github.com/almogbcr/helm-gitops-demo.git"
        cd helm-gitops-demo
        git checkout "$TARGET_BRANCH"

        tmp_file="$(mktemp)"
        awk -v new_tag="$SHA_TAG" '
          function indent_len(s,   m) {
            match(s, /^[ ]*/)
            return RLENGTH
          }
          {
            line = $0
            curr_indent = indent_len(line)

            if (line ~ /^[ ]*image:[ ]*$/) {
              in_image = 1
              image_indent = curr_indent
              print line
              next
            }

            if (in_image && line !~ /^[ ]*$/ && curr_indent <= image_indent) {
              in_image = 0
            }

            if (in_image && line ~ /^[ ]*tag:[ ]*/) {
              sub(/tag:[ ]*.*/, "tag: \"" new_tag "\"", line)
              updated = 1
            }

            print line
          }
          END {
            if (!updated) {
              exit 2
            }
          }
        ' "$VALUES_FILE" > "$tmp_file" || {
          code=$?
          rm -f "$tmp_file"
          if [ "$code" -eq 2 ]; then
            echo "Did not find image.tag in $VALUES_FILE"
          fi
          exit "$code"
        }
        mv "$tmp_file" "$VALUES_FILE"

        if git diff --quiet -- "$VALUES_FILE"; then
          echo "No changes detected in $VALUES_FILE. Nothing to commit."
          exit 0
        fi

        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git add "$VALUES_FILE"
        git commit -m "Update myapp image tag to ${SHA_TAG} (${TARGET_BRANCH})"
        git push origin "$TARGET_BRANCH"
        echo "Pushed update to branch '$TARGET_BRANCH' for file '$VALUES_FILE'."
